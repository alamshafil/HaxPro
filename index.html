<!DOCTYPE html>
<html>
    <head>
        <title>HaxPro</title>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/theme.css">
        
        <link rel="stylesheet" href="js/fa/css/all.min.css"/>

        <link rel="stylesheet" href="css/bootstrap.css">

        <link rel="stylesheet" href="css/toastr.css">

        <link rel="stylesheet" href="css/grapes.css">

        <link rel="stylesheet" href="css/grapes-webpage.css">

        <link rel="stylesheet" href="node_modules/xterm/css/xterm.css">

        <link rel="stylesheet" data-name="vs/editor/editor.main" href="node_modules/monaco-editor/min/vs/editor/editor.main.css">

    </head>

    <body> 
      
      <div class="se-pre-con"></div>

        <div id="titlebar">
            <div id="drag-region">
              <div id="window-title">
                <div id="window-inner">
                  <a style="margin-right: 10px;">
                      <img src="logos/logo-full.png" width="100" height="30" style=" display: inline-block; vertical-align: center;">
                    </a>
                      <button class="btn btn-dark" onclick="initFS()"><i class="fa fa-plus-square"></i></i> New</button>
                      <button class="btn btn-dark" onclick="saveProject()"><i class="fa fa-save"></i> Save</button>
                      <button class="btn btn-dark" onclick="openProject()"><i class="fa fa-folder-open"></i></i> Open</button>
                      <button id="run-btn" class="btn btn-dark" onclick="if(sessionStorage['type'] == 'gui'){if(editor.getValue().includes('use: haxpro.ui')){run_gui(editor.getValue(), ui.getHtml(), ui.getCss(), ui.getJs())} else {run_gui(editor.getValue())}} else if(sessionStorage['type'] == 'cmd'){}"><i class="fa fa-wrench"></i> Run</button>
                      <button class="btn btn-dark" onclick="if(sessionStorage['type'] == 'gui'){compile_gui(editor.getValue())} else if(sessionStorage['type'] == 'cmd'){}"><i class="fa fa-cogs"></i> Compile</button>
                        <button class="btn btn-dark dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          <i class="fa fa-ellipsis-h"></i> More
                        </button>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                          <a style="color:black" class="dropdown-item" onclick="requestFullScreen()"><i class="fa fa-compress"></i> Fullscreen</a>
                          <div class="dropdown-divider"></div>
                          <a style="color:black" class="dropdown-item" onclick="browser()"><i class="fa fa-file-code"></i> App Store</a>
                          <a style="color:black" class="dropdown-item" onclick="UI()"><i class="fa fa-file-code"></i> UI Editor</a>
                          <div class="dropdown-divider"></div>
                          <a style="color:black" class="dropdown-item" onclick=""><i class="fa fa-info"></i> About</a>
                        </div>
                </div>
              </div>
              
              <div id="window-controls">
                <div class="button" id="min-button">
                  <span>&#xE921;</span>
                </div>
                <div class="button" id="max-button">
                  <span>&#xE922;</span>
                </div>
                <div class="button" id="restore-button">
                  <span>&#xE923;</span>
                </div>
                <div class="button" id="close-button">
                  <span>&#xE8BB;</span>
                </div>
              </div>
            </div>
          </div>

    <div class="pre" style="background-color: #343a40; text-align:center; padding: 70px 0; background: url('logos/intro.png'); background-size: cover;">
      <div class="card" style="background-color: white; color: black;">
        <div class="container">
          <img width="200" height="60" style="margin-top: 20px; margin-bottom: 15px;" src="logos/logo-full.png"></img>
          <br>
          <button class="btn btn-light" onclick="initFS()"><i class="fa fa-plus-square"></i></i> New</button>
          <button class="btn btn-light" onclick="openProject()"><i class="fa fa-folder-open"></i></i> Open</button>
          <button class="btn btn-light" onclick="compile(editor.getValue(), getData())"><i class="fa fa-cogs"></i> Compile</button>      
        </div>
      </div>
    </div>

    <div class="content">
      <div id="win-left" class="left">
          <div id="collapse" style="float: right; margin: auto; padding-right: 10px; color: white; padding: 2px;">
            <button style="color: white;" class="btn btn-darker shadow-none" onclick="collapse()"><i class="fa fa-angle-right"></i></button>
          </div>
          <ul left-tabs id="left-tab">
              <li><a style="color:white" data-tabby-default href="#code" href="#code"><i class="fa fa-code" aria-hidden="true"></i>
                Code Editor</a></li>

      </div>

      <div id="code"><div class="left" id="editor"></div></div>
            
        <div id="win-right" class="right">
          <div id="main">  
              <ul right-tabs id="right-tab">
                  <li><a style="color:white" data-tabby-default href="#output"><i class="fa fa-terminal" aria-hidden="true"></i>
                    Output</a></li>
                  <li><a style="color:white" href="#doc"><i class="fa fa-book" aria-hidden="true"></i>
                    Docs</a></li>
                </ul>
                
                <div id="output" style="width:100%; height:100%"><div class="left" style="height: calc(100% - 268px); position: absolute; background: rgb(46, 46, 46)" id="window"> <figure style="text-align:center; padding: 70px 0;">
                    <i class="fa fa-code" style="font-size: 50px; color: grey;"></i>
                    <figcaption style="color:gray"><i>Press 'Run' to see your project here.</i></figcaption>
                  </figure> 
                </div>
              </div>
                
                <div id="doc"><div class="left" id="docs"></div></div>  

                <div class="output">
                    <ul term-tabs id="term-tab">
                        <li><a style="color:white" data-tabby-default href="#term-inner"><i class="fa fa-terminal" aria-hidden="true"></i>
                          Terminal</a></li>
                        <li><a style="color:white" href="#console-inner"><i class="fa fa-book" aria-hidden="true"></i>
                          Console</a></li>
                          <li><a style="color:white" href="#files-inner"><i class="fa fa-book" aria-hidden="true"></i>
                            Files</a></li>
                      </ul>
                      
                      <div id="term-inner" style="height: 130px;">
                        <div style="height: 130px;" class="left" id="term">
                        </div>
                      </div>

                      <div id="console-inner" style="height: 150px; background-color: rgb(46, 46, 46);">
                        <div class="left" style="height: 150px; background-color: rgb(46, 46, 46);" id="console">
                          <p><font color="red">Error</font> HaxProInvaild - 'haxpro.main' is a invaild object</p>
                       </div>
                      </div> 

                      <div id="files-inner" style="height: 150px; background-color: rgb(46, 46, 46);">
                        <div class="left" style="height: 150px; background-color: rgb(46, 46, 46);" id="files">
                          <p><font color="red">Error</font> I'm still working on this!</p>
                       </div>
                      </div>
                </div>
          </div>
        </div> 
    </div>  

    <div id='cntnr'>
        <ul id='items'>
          <li onclick=" var sel = editor.selection.toJSON(); // save selection
          document.execCommand('copy');
          editor.selection.fromJSON(sel); // restore selection">Copy</li>
          <li onclick=" var sel = editor.selection.toJSON(); // save selection
          document.execCommand('paste');
          editor.selection.fromJSON(sel); // restore selection">Paste</li>
          <li onclick=" var sel = editor.selection.toJSON(); // save selection
          document.execCommand('cut');
          editor.selection.fromJSON(sel); // restore selection">Delete</li>  
        </ul>
        <hr />
        <ul id="items">
          <li>New</li>
          <li>Open</li>
          <li>Save</li>
        </ul>
        <hr />
        <ul id='items'>
          <li>Run</li>
          <li>Compile</li>  
        </ul>
      </div>

        <script>window.$ = window.jQuery = require('jquery');</script>

        <!--<script>window.xterm = require('xterm');</script>-->

        <script>window.os = require('os');</script>

        <script>window.pty = require('node-pty');</script>

        <script src="node_modules/xterm/lib/xterm.js"></script>
  
        <script src="js/code.js"></script>
        
        <script src="js/gui/runtime.js"></script>
        
        <script src="js/gui/runtime-ide.js"></script>

        <script src="js/gui/runtime-jit.js"></script>

        <script src="js/tabs.js"></script>

        <script src="js/fa/js/all.min.js"></script>

        <script src="js/modernizr.js"></script>

        <script src="js/tabby.js"></script>

        <script src="js/math.js"></script>

        <!-- <script src="js/ace.js"></script> -->

        <!-- <script src="https://ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js"></script> -->

        <!-- <script src="js/ace_tools.js"></script> -->

        <script src="js/popper.js"></script>

        <script src="js/bootstrap.js"></script>

        <script src="js/bootbox.js"></script>

        <script src="js/grapes.js"></script>

        <script src="js/grapes-webpage.js"></script>

        <script>
          // Monaco uses a custom amd loader that over-rides node's require.
          // Keep a reference to node's require so we can restore it after executing the amd loader file.
          var nodeRequire = require;
        </script>
        <script src="node_modules/monaco-editor/min/vs/loader.js"></script>
        <script>
          // Save Monaco's amd require and restore Node's require
          var amdRequire = require;
          require = nodeRequire;
          require.nodeRequire = require;
        </script>
      
        <script>
          amdRequire.config({
            baseUrl: 'node_modules/monaco-editor/min'
          });
      
          // workaround monaco-css not understanding the environment
          self.module = undefined;
      
          // workaround monaco-typescript not understanding the environment
          self.process.browser = true;

          amdRequire(['vs/editor/editor.main'], function() {

            monaco.languages.register({ id: 'haxpro' });

            // Register a tokens provider for the language
            

            function getToken() {
              // Create your own language definition here
              // You can safely look at other samples without losing modifications.
              // Modifications are not saved on browser refresh/close though -- copy often!
              return {
                // Set defaultToken to invalid to see what you do not tokenize yet
                // defaultToken: 'invalid',

                keywords: [
                  'use:', 'write:', 'math:'
                ],

                operators: [
                  '<>', '()', '{}', '+', '-', '*', '/', '^'
                ],

                // we include these common regular expressions
                symbols:  /[=><!~?:&|+\-*\/\^%]+/,

               // C# style strings
                escapes: /\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,

              // The main tokenizer for our languages
              tokenizer: {
                root: [
                  // identifiers and keywords
                  [/[a-z_$][\w$]*/, { cases: { '@typeKeywords': 'keyword',
                                              '@keywords': 'keyword',
                                              '@default': 'identifier' } }],
                  [/[A-Z][\w\$]*/, 'type.identifier' ],  // to show class names nicely

                  // whitespace
                  { include: '@whitespace' },

                  // delimiters and operators
                  [/[{}()\[\]]/, '@brackets'],
                  [/[<>](?!@symbols)/, '@brackets'],
                  [/@symbols/, { cases: { '@operators': 'operator',
                                          '@default'  : '' } } ],

                  // @ annotations.
                  // As an example, we emit a debugging log message on these tokens.
                  // Note: message are supressed during the first load -- change some lines to see them.
                  [/@\s*[a-zA-Z_\$][\w\$]*/, { token: 'annotation', log: 'annotation token: $0' }],

                  // numbers
                  [/\d*\.\d+([eE][\-+]?\d+)?/, 'number.float'],
                  [/0[xX][0-9a-fA-F]+/, 'number.hex'],
                  [/\d+/, 'number'],

                  // delimiter: after number because of .\d floats
                  [/[;,.]/, 'delimiter'],

                  // strings
                  [/"([^"\\]|\\.)*$/, 'string.invalid' ],  // non-teminated string
                  [/"/,  { token: 'string.quote', bracket: '@open', next: '@string' } ],

                  // characters
                  [/'[^\\']'/, 'string'],
                  [/(')(@escapes)(')/, ['string','string.escape','string']],
                  [/'/, 'string.invalid']
                ],

                comment: [
                  [/[^\/*]+/, 'comment' ],
                  [/\/\*/,    'comment', '@push' ],    // nested comment
                  ["\\*/",    'comment', '@pop'  ],
                  [/[\/*]/,   'comment' ]
                ],

                string: [
                  [/[^\\"]+/,  'string'],
                  [/@escapes/, 'string.escape'],
                  [/\\./,      'string.escape.invalid'],
                  [/"/,        { token: 'string.quote', bracket: '@close', next: '@pop' } ]
                ],

                whitespace: [
                  [/[ \t\r\n]+/, 'white'],
                  [/\/\*/,       'comment', '@comment' ],
                  [/\/\/.*$/,    'comment'],
                ],
              },
              };  

            }

            // Register a completion item provider for the new language
            monaco.languages.registerCompletionItemProvider('haxpro', {
              provideCompletionItems: () => {
                var suggestions = [{
                  label: 'simpleText',
                  kind: monaco.languages.CompletionItemKind.Text,
                  insertText: 'simpleText'
                }, {
                  label: 'testing',
                  kind: monaco.languages.CompletionItemKind.Keyword,
                  insertText: 'testing(${1:condition})',
                  insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                }, {
                  label: 'ifelse',
                  kind: monaco.languages.CompletionItemKind.Function,
                  insertText: [
                    'if (${1:condition}) {',
                    '\t$0',
                    '} else {',
                    '\t',
                    '}'
                  ].join('\n'),
                  insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                  documentation: 'The Lodash library exported as Node.js modules.'
                }];
                return { suggestions: suggestions };
              }
            });

            window.editor = monaco.editor.create(document.getElementById('editor'), {
              language: 'haxpro',
              automaticLayout: true,
              theme: 'vs-dark'
            });

          });
        </script>

        <script>

    window.toastr = require('toastr');

    require('./js/window.js');

    var left_tabs = new Tabby('[left-tabs]');
    var right_tabs = new Tabby('[right-tabs]');
    var term_tabs = new Tabby('[term-tabs]');

  window.onerror = function(error, url, line) {
    $('#console').append(`<p><font color="red">Error </font>${error}</p>`);

    bootbox.dialog({
    title: 'Internal Error',
    message: `<p>HaxPro has reached an internal error. This may be caused by a error in your code, or a error in the HaxPro IDE itself. The error states: </p> <b>${error}</b>`,
    size: 'large',
    buttons: {
      ok: {
            label: "Ok",
            className: 'btn-info',
            callback: function(){
            }
        },
        report: {
            label: "Report",
            className: 'btn-info',
            callback: function(){
               bootbox.alert("I didn't make this yet, sorry.");
            }
          }
        }
    });
    return false;
};

var term = new Terminal({
  theme: {
    background: 'rgb(46, 46, 46)'
  },
  fontSize: 12,
  experimentalCharAtlas: 'dynamic'
});

term.open(document.getElementById('term'));

const shell = process.env[os.platform() === 'win32' ? 'COMSPEC' : 'SHELL'];
const ptyProcess = pty.spawn(shell, [], {
  name: 'xterm-color',
  cols: term.cols,
  rows: term.rows,
  cwd: process.cwd(),
  env: process.env
});

term.onData(data => ptyProcess.write(data));
ptyProcess.on('data', function (data) {
  term.write(data);
});

const { remote } = require('electron');
const { BrowserWindow } = remote;

var dialog = remote.dialog;
var fs = require('fs');

function initFS()
{
  bootbox.prompt("Please enter the name for your app.", function(result){ 
    sessionStorage['name'] = result;
    console.log(sessionStorage['name']);
    pickProject();
  });

  function pickProject(){ 
    bootbox.dialog({
    title: 'New Project',
    message: "<p>Choose a project type to create.</p>",
    size: 'large',
    buttons: {
        gui: {
            label: "GUI Application",
            className: 'btn-info',
            callback: function(){ 
              newProject_gui();
            }
          },
        cmd: {
            label: "Console Application",
            className: 'btn-info',
            callback: function(){ 

            }
          }
        }
      });
    }
}

function newJSON(name, type, tabs){
  var json = `{"project": {"name": "${name}", "type": "${type}", "tabs": ${tabs}}}`;
  return json;
}

function newProject_gui(){
$('.content').css('display', 'block');
$('.pre').css('display', 'none');
dialog.showOpenDialog({
    title:"Select a folder",
    properties: ["openDirectory"]
}, (folderPaths) => {
    // folderPaths is an array that contains all the selected paths
    if(folderPaths === undefined){
        console.log("No destination folder selected");
        return;
    }else{
        console.log(folderPaths);
        var path = folderPaths[0];

        sessionStorage['project'] = path;

        fs.mkdirSync(path+'/code');
        fs.mkdirSync(path+'/files');
        fs.mkdirSync(path+'/builds');

        fs.writeFile(path+'/code/main.hax', 'use: haxpro.main \nuse: haxpro.ui\n\nMain<> \n\n', (err) => {
            if(err){
              bootbox.alert("An error ocurred creating the file "+ err.message)
            }
        }); 

        var json = newJSON(sessionStorage['name'], "gui", '["ui_editor"]')

        fs.writeFile(path+'/app.haxproj', json, (err) => {
            if(err){
              bootbox.alert("An error ocurred creating the file "+ err.message)
            }
        }); 
        
        fs.readFile(path+'/code/main.hax', 'utf-8', (err, data) => {
            if(err){
                bootbox.alert("An error ocurred reading the file :" + err.message);
                return;
            }
    
            // Change how to handle the file content
            console.log("The file content is : " + data);
            editor.setValue(data);
        });

        fs.readFile(path+'/app.haxproj', 'utf-8', (err, data) => {
            if(err){
                bootbox.alert("An error ocurred reading the file :" + err.message);
                return;
            }

            var dat = JSON.parse(data);

            var type = dat.project.type;
            var array = dat.project.tabs;
            
            for(i=0; i < array.length; i++) {
              switch (array[i]) {
                case "ui_editor":
                  UI();
                  break;
              
                default:
                  break;
              }
            }

            sessionStorage["type"] = type;
            sessionStorage["tabs"] = array;

            document.getElementById('current').innerHTML = `<i class="fa fa-folder-open"></i> ${sessionStorage["name"]}`;
        }); 
      }
});

editor.onKeyDown(function(){
              updateBar();
          });
}

function openProject(){
  $('.content').css('display', 'block');
  $('.pre').css('display', 'none');
    dialog.showOpenDialog({
        title:"Select a file",
        properties: ["openFile"],
        filters: [
        { name: 'HaxPro Project', extensions: ['haxproj'] },
        { name: 'All Files', extensions: ['*'] }
      ] ,
    }, (filePath) => {
        // folderPaths is an array that contains all the selected paths
        if(filePath === undefined){
            bootbox.alert("No destination folder selected");
            return;
        }else{
            var path = getPath(filePath.toString());
    
            sessionStorage['project'] = path;
    
            fs.readFile(path+'/code/main.hax', 'utf-8', (err, data) => {
            if(err){
                bootbox.alert("An error ocurred reading the file :" + err.message);
                return;
            }
    
            // Change how to handle the file content
            console.log("The file content is : " + data);
            editor.setValue(data);
        }); 

        fs.readFile(path+'/app.haxproj', 'utf-8', (err, data) => {
            if(err){
                bootbox.alert("An error ocurred reading the file :" + err.message);
                return;
            }

            var dat = JSON.parse(data);

            var name = dat.project.name;
            var type = dat.project.type;
            var array = dat.project.tabs;
            
            for(i=0; i < array.length; i++) {
              switch (array[i]) {
                case "ui_editor":
                  UI();
                  break;
              
                default:
                  break;
              }
            }

            sessionStorage["name"] = name;
            sessionStorage["type"] = type;
            sessionStorage["tabs"] = array;

            document.getElementById('current').innerHTML = `<i class="fa fa-folder-open"></i> ${sessionStorage["name"]}`;
        }); 
      }
    });
        
    editor.onKeyDown(function(){
              updateBar();
          });
    }

    function saveProject(){
            var path = sessionStorage['project'];
    
            fs.writeFile(path+'/code/main.hax', editor.getValue(), (err) => {
            if(err){
                bootbox.alert("An error ocurred creating the file "+ err.message)
            }
        });
  
        document.getElementById('status').innerHTML = '<i class="fa fa-sync"></i> Saving project...</i>';
        setTimeout(function(){document.getElementById('status').innerHTML = '<i class="fa fa-check"></i> Everything is okay.';}, 10000);

    }
   
    $("#defaultOpen").click();

      function updateBar() {
        var ln = document.getElementById('bar-ln');
        ln.innerHTML = `Ln ${editor.getPosition().lineNumber}, Col ${editor.getPosition().column}`
      }

      $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();
        $('.pre').css('display', 'block');
        $('.content').css('display', 'none');
        document.getElementById('status').innerHTML = '<i class="fa fa-sync"></i> Checking for updates...</i>';
        setTimeout(function(){document.getElementById('status').innerHTML = '<i class="fa fa-check"></i> Everything is okay.';}, 10000);
      });
      </script>

      <div class="footer" style="width: 100%; height: 20px;">
          <span id="current" data-toggle="tooltip" title="Current project"><i class="fa fa-folder-open"></i> No project is open.</span>

          <span data-toggle="tooltip" title="Errors" style="padding-left: 10px"><i class="fa fa-exclamation-triangle"></i> 0</span>

          <span id='status' data-toggle="tooltip" title="Status" style="padding-left: 10px"><i class="fa fa-check"></i> Everything is okay.</span>

          <span data-toggle="tooltip" title="Version" style="text-align: right; float: right; padding-right: 10px"><i>v0.2-alpha</i></span>
          
          <span data-toggle="tooltip" title="Cursor Position" id="bar-ln" style="text-align: right; float: right; padding-right: 10px">Ln 0, Col 0</span>

        </div>

    </body>

</html>